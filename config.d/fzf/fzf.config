# FZF SHELL UTILITY CONFIGURATION

# @TODO: Do full check for dependencies including FZF binary itself when sourcing in BASH 
# shells/BASHRCs. Use 'marlo' or other bare metal install users as test user.

##############################
#   Dependencies
##############################

# fd 
if [ "$(which fd)" != "$HOME/.local/bin/fd" ]; then
  echo "'fd' binary NOT FOUND in $HOME/.local/bin therefore the FZF selector tool will fallback to the 'find' utility"
  # use `find | egrep -vf` with below ignore patterns to simulate fd-like defaults
  export FIND_IGNORE_REGEX_PATTERN_FILE="$HOME/dotfiles/config.d/find/find_ignore_patterns"
  SELECTOR_TOOL="find -type f | egrep -vf ""'$FIND_IGNORE_REGEX_PATTERN_FILE'"
  echo "SELECTOR_TOOL: $SELECTOR_TOOL"
  export FZF_DEFAULT_COMMAND="$SELECTOR_TOOL"

else
  echo "'fd' binary found in $HOME/.local/bin and will be used as FZF selector tool"
  SELECTOR_TOOL="fd"
  export FZF_DEFAULT_COMMAND='fd --type f --strip-cwd-prefix --hidden --follow --exclude .git'
fi

# bat 
if [[ "$(which bat)" != "$HOME/.local/bin/bat" ]]; then
  echo "'bat' not installed, using 'less' as fallback"
  FZF_PAGER="less -R"
else
  echo "'bat' installed, and will be used as PAGER"
  FZF_PAGER="bat -n --color=always {}"
  
  # @WORKAROUND: just keep ops what they were with the default but have bashrc_wsl for user
  # override them if their system is missing depedency (e.g. bat/fd)

  #export FZF_CTRL_T_OPTS="  --preview 'bat -n --color=always {}'"
fi

echo "" && echo "FZF_DEFAULT_COMMAND:  $FZF_DEFAULT_COMMAND"
echo "FZF_PAGER: $FZF_PAGER"

##############################
#   Key Binding Configs
##############################

# TODO: improve below default/default options



# nord color scheme 
export FZF_DEFAULT_OPTS="
  --no-height
  --color=fg:#e5e9f0,bg:#3b4252,hl:#81a1c1 
  --color=fg+:#e5e9f0,bg+:#3b4252,hl+:#81a1c1
  --color=info:#eacb8a,prompt:#bf6069,pointer:#b48dac 
  --color header:italic
  --color=marker:#a3be8b,spinner:#b48dac,header:#a3be8b"

# CTRL-T
export FZF_CTRL_T_COMMAND="$SELECTOR_TOOL"' -t f'
#export FZF_CTRL_T_OPTS="  --preview 'bat -n --color=always {}'"
export FZF_CTRL_T_OPTS="$SELECTOR_TOOL --preview $FZF_PAGER "

# ALT-C
export FZF_ALT_C_COMMAND="$SELECTOR_TOOL"' -t d . $HOME'    # use $HOME instead of CWD as FZF starting point
export FZF_ALT_C_OPTS="--preview 'tree -C {} | head -200'"

# CTRL-R/History
export FZF_CTRL_R_OPTS="
  --preview 'echo {}' --preview-window up:3:hidden:wrap
  --bind 'ctrl-e:toggle-preview'
  --bind 'ctrl-y:execute-silent(echo -n {2..} | xclip)+abort'
  --color header:italic
  --header 'Press CTRL-Y to copy command to clipboard and CTRL-E to toggle command preview in an upper pane'"

_fzf_complete_man(){
    local lbuf="$1"
    local prefix="$2"
    local name section dash description
    local matches=($(man -k . | fzf -m | while read -r name section dash description; do
        echo "$name.${${section#\(}%\)}"
    done))
    [ -z "$matches" ] && return 1
    LBUFFER="$LBUFFER${matches[@]}"
}

